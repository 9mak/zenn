---
title: "DialogFlow CXで天気予報チャットボットをつくる: Entity編"
emoji: "🌥️"
type: "tech" # tech: 技術記事 / idea: アイデア記事
topics: ["gc24", "gcp", "dialogflowcx", "chatbot", "ai"] # 記事に関連するトピックをここに入力
published: true
publication_name: "ap_com"
published_at: 2024-03-20 12:00
---

## 🌟 はじめに

おぐまです。

勉強も兼ねてDialogFlow CXを使用した天気予報チャットボットを作ります！

それぞれ設定項目を分割して説明していて、前回は `Intentの作成` について説明しました。

1. `Intent`の作成
2. `Entity`の作成　👉 ココ！
3. `Flow,Pages`の作成
4. `???` ※ここで作成したシンプルチャットボットを改造(応用)する

今回は2番の `Entityの作成` について説明します。

## 👷‍♂️ 事前準備

- Google Cloud Platform アカウント
- DialogFlow CX Agent

https://zenn.dev/ap_com/articles/dialogflowcx-basic-guide

:::message
ここまでの前提知識含む事前準備は、上記にまとめてあるのでぜひ参考にしてみてください
:::

## 📖 ステップ

### 👉 Entityの理解

`Entity` は、ユーザーの発言から**具体的な情報**を抽出しその情報をもとに適切な**アクションを決定**するためのものです。
Entityを上手く使うことでチャットボットはユーザーの意図をより正確に解釈できるようになり、より適切な回答をしてくれるようになります。

-----

ここで`Intent`との違いをさらっとまとめておきます(自分もこんがらがったので)

**EntityとIntentの主な違い**:

- **Entity**:
  具体的な情報やデータを識別し、抽出する役割
  例えば、「東京」という地名や「今日」という日付など、特定の情報を識別する

- **Intent**:
  ユーザーの発言や質問から意図を識別する役割
  ユーザーが何を求めているのか、どのようなアクションを望んでいるのかを理解するために使われる

**具体例での説明**:

ユーザーが「今日の東京の天気は？」と質問した場合

- **Entity** は「**今日**(`@sys.date`)」という日付と「**東京**(`@sys.geo-city`)」という地名を識別し、これらの情報をチャットボットが利用して天気の情報を提供するためのデータとして抽出します。
- **Intent** はこの質問が「天気情報を知りたい」という意図を持っていることを識別します。

`Entity`と`Intent`がユーザーの入力を理解し、適切な応答を生成するために必要な情報を提供することで
チャットボットはユーザーに対してより精度の高い対話を行うことができるようになるということですね🕵️‍♂️

#### 📺 Entity画面の機能

![Entity_Top](/images/dialogflow-chatbot-shuzo-weather-forecast-entity/Entity_Top.jpeg)

| 機能・要素            | 説明                                                                                           |
|-------------------|------------------------------------------------------------------------------------------------|
| Entities          | 既存のEntityのリストを表示し、新しいEntityの追加や編集を行います                         |
| Create            | 新しいEntityを作成するためのボタンです                                                     |
| Import            | Entityの定義を外部ファイルやCloud Storageに保存されているファイルからインポートする機能です |

#### 📺 Entity作成画面の主な要素

![Entity_Create](/images/dialogflow-chatbot-shuzo-weather-forecast-entity/Entity_Create.jpg)

| 要素                          | 説明                                                                                       |
|-----------------------------|------------------------------------------------------------------------------------------|
| Entity type                | 情報のタイプを定義します。時間や日付などの共通情報タイプにはシステムEntityがありますが、独自のものを作成することもできます。|
| Display name               | ディスプレイ名です。文字、数字、アンダースコア、ダッシュを含むことができ、文字で始まる必要があります。                           |
| Entities only (no synonyms) | シノニムを持たないEntityのみを指定します。                                                      |
| Regexp entities            | 正規表現に基づいてEntityを指定します。                                                         |
| Entities                   | Entityを追加するには、参照値とオプショナルなシノニムを入力します。例: Entityタイプが野菜の場合、参照値として「ネギ」、オプショナルなシノニムとして「青ネギ」があります。|
| Search                     | Entityを検索します。                                                                       |
| Advanced settings          | 自動拡張、ファジーマッチング、ログでのマスキングなどの高度な設定。                                               |
| Automatic expansion        | Entityがユーザーの入力に自動的に適応するかどうかを指定します。                                                   |
| Fuzzy matching             | 入力がEntityに完全に一致しない場合でも、類似性に基づいてマッチングを試みます。                                    |
| Redact in log              | ログに記録されるときにEntityの値をマスキングします。                                                      |
| Entity exclusions          | マッチングされるべきではない例外フレーズのコレクションです。例: サイズEntityタイプに「巨大」(形容詞)がある場合、「巨人」(名詞)を除外として追加することを検討します。|

:::message alert

-----

- **シノニム**: 異なる言葉や表現で同じまたはほぼ同じ意味を持つ言葉のこと
  例えば以下のようにした場合、ユーザーが「`ジョジョ`」に関連するさまざまな表現を使っても、DialogFlow CXはそれら全てを「`ジョジョ`」というEntityとして識別します。
  - Entityタイプ: `ジョジョ`
  - 基本的な識別子: `ジョジョ`
  - シノニム:
    - `ジョナサン・ジョースター`
    - `ジョセフ・ジョースター`
    - `空条承太郎`

-----

- **ファジーマッチング**: 類似性に基づいて最も近いものを見つけ出す技術のこと
  ファジーマッチングを利用することでユーザーの入力がEntityの定義と完全には一致しない場合でも、その意図を推測し適切なEntityを識別できます。
  例えばユーザーが「`貧弱ゥ！`」と入力した場合、Entityに「`貧弱`」という表現が登録されていたとしてもファジーマッチングにより「`貧弱ゥ！`」が「`貧弱`」と類似していると判断され、適切にEntityが識別されます。

-----

:::

### 👉 Entityの作成

1. **エンティティタイプの選択**:
   - **Entity type**: 天気予報チャットボットの場合、日付や地域名などの情報が大事なのでシステムエンティティ（例：`@sys.date`、`@sys.geo-city`）を利用するか、地域名などのカスタムエンティティを作成します。

2. **表示名の設定**:
   - **Display name**: わかりやすい名前を設定します。地域名を扱うエンティティであれば「Location」とする。

3. **エンティティの追加**:
   - **Entities**: 「Location」エンティティの場合、参照値として具体的な地域名（例：「東京」）と、オプショナルなシノニム（例：「とうきょう」）を追加します。

4. **オプション設定**:
   - **Automatically expand**: 地域名などのエンティティでは、新しい地域名に対応できるようにこのオプションを有効にする。
   - **Fuzzy matching**: 地域名の入力に多少の誤りがあってもマッチングさせたい場合は、このオプションを有効にします。
   - **Entity exclusions**: マッチングされるべきではない例外フレーズ設定する。

5. **エンティティの保存**:
   - 設定が完了したら、「Save」ボタンをクリックしてエンティティを保存します。

6. **エンティティのインポート** (オプショナル):
   - 大量の地域名などを一括で追加したい場合は、「Import」機能を利用して、エンティティのリストが記載されたCSVファイルをインポートします。

:::message alert

- `Intent`の時と違って`Entity`のインポートファイルはクセがすごいです、、
- まずは手動で作成 👉 EntityをファイルにExportすることでどんなものか見れるのでぜひご参照ください

:::

天気予報に関連する重要な情報（日付、地域名など）を抽出するエンティティを作成したので、チャットボットがユーザーからの質問に対して正確に応答できるようになります。

### 💡 補足 : EntityとIntentの連携について

DialogFlow CXでのチャットボットでは `Entity` と `Intent` は連携して動作します。
これらがどう連携してユーザーの質問に対する適切な応答を生成するかを解説します。

#### Step 1: ユーザーの入力受付

まず、ユーザーがチャットボットに質問や命令を入力します。
「今日の東京の天気は？」という質問があったとします。

#### Step 2: Intentの識別

DialogFlow CXはユーザーの入力から「天気を知りたい」という意図（Intent）を識別します。
この段階でユーザーの言葉が含むキーワードやフレーズ、文脈などを分析してどの`Intent`にマッチするかを判断します。

#### Step 3: Entityの抽出

次に、DialogFlow CXは入力から具体的な情報（Entity）を抽出します。
今回の例では「今日」が日付Entity（`@sys.date`）、そして「東京」が地域名Entity（`@sys.geo-city`）として識別されます。
※`Entity`は`Intent`の処理に必要な具体的なパラメータとして機能します。

#### Step 4: 応答の生成

`Intent`と抽出された`Entity`の情報を基に、DialogFlow CXが適切な応答を生成します。
今回の場合「今日の東京の天気」に関する情報を提供するフローが起動👉設定された情報源から天気データを取得👉ユーザーに応答として表示してくれます。

## 🎉 まとめ

この記事では、DialogFlow CXを使用して天気予報チャットボットを作成する際の`Entity`の設定方法について詳しく解説しました。
`Intent`と`Entity`のつながりも説明したのでイメージできたでしょうか？

次のステップでは、これまでに作成した`Intent`と今回作成した`Entity`を使って、ユーザーに応じたフローとページを設計する方法について詳しく説明します！

## 💡 参考

https://cloud.google.com/dialogflow/cx/docs/concept/entity?hl=ja
